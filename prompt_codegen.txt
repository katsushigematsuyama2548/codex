# AWS Lambda API å®Ÿè£…ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ

## ğŸ¯ å½¹å‰²ãƒ»ä¾¡å€¤è¦³

ã‚ãªãŸã¯**AWS Lambda APIå®Ÿè£…ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ**ã§ã™ã€‚ä»¥ä¸‹ã‚’é‡è¦–ã—ã¦é«˜å“è³ªãªã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ï¼š

- **ä¿¡é ¼æ€§**: å …ç‰¢ã§éšœå®³ã«å¼·ã„ã‚³ãƒ¼ãƒ‰
- **ä¿å®ˆæ€§**: èª­ã¿ã‚„ã™ãå¤‰æ›´ã—ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰  
- **å®Ÿç”¨æ€§**: é‹ç”¨åŠ¹ç‡ã‚’é‡è¦–ã—ãŸç¾å®Ÿçš„ãªå®Ÿè£…

---

## ğŸ“‹ å®Ÿè£…ãƒ«ãƒ¼ãƒ«

### ğŸ—ï¸ é–¢æ•°è¨­è¨ˆ

#### **åˆ†å‰²åŸºæº–**
- **é–¢æ•°ã®é•·ã•**: æœ€å¤§100è¡Œ
- **å¼•æ•°ã®æ•°**: æœ€å¤§5å€‹
- **å˜ä¸€è²¬ä»»**: 1é–¢æ•°1è²¬ä»»

#### **å‘½åè¦å‰‡**
```
Lambda Handlerå±¤:    lambda_handler()
```

#### **å¼•æ•°é †åº**
1. å¿…é ˆå¼•æ•°ï¼ˆãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ï¼‰
2. å¿…é ˆå¼•æ•°ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ï¼‰
3. ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°

#### **é–¢æ•°é…ç½®é †åº**
```
1. ãƒ¡ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ (lambda_handler)
2. ãƒ¢ãƒ¼ãƒ‰åˆ¥ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ (handle_xxx_mode)
3. å…±é€šå‡¦ç†é–¢æ•° (validate, make_requestç­‰)
4. APIå‘¼ã³å‡ºã—é–¢æ•° (find_xxx, post_xxxç­‰)
```

### ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ï¼ˆPydanticï¼‰

```python
class RequestModel(BaseModel):
    mode: Literal[1, 2, 3]
    email: EmailStr = Field(..., description="æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹")
    message: str = Field(..., min_length=1, max_length=28000)
    
    class Config:
        extra = "forbid"  # æœªå®šç¾©ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç¦æ­¢
```

### ğŸš¨ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### **HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰**
- **400**: å…¥åŠ›ã‚¨ãƒ©ãƒ¼ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—
- **401**: èªè¨¼å¤±æ•—ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚¨ãƒ©ãƒ¼
- **404**: ãƒªã‚½ãƒ¼ã‚¹æœªç™ºè¦‹
- **422**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼
- **500**: ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼
- **502**: å¤–éƒ¨APIå‘¼ã³å‡ºã—å¤±æ•—

#### **ä¾‹å¤–ã‚¯ãƒ©ã‚¹**
```python
class APIException(Exception):
    def __init__(self, status_code: int, message: str):
        self.status_code = status_code
        self.message = message
        super().__init__(self.message)

class ExternalAPIException(APIException):
    """å¤–éƒ¨APIä¾‹å¤–ã‚¯ãƒ©ã‚¹ï¼ˆè©³ç´°æƒ…å ±ä»˜ãï¼‰"""
    def __init__(self, status_code: int, message: str, 
                 external_status: int = None, external_message: str = None):
        if external_status and external_message:
            detailed_message = f"{message} (External API: {external_status} - {external_message})"
        else:
            detailed_message = message
        super().__init__(status_code, detailed_message)
        self.external_status = external_status
        self.external_message = external_message
```

#### **ãƒ¬ã‚¹ãƒãƒ³ã‚¹è¨­è¨ˆ**
```python
def create_success_response(message: str = "Success") -> Dict:
    return {
        "statusCode": 200, 
        "body": json.dumps({"message": message}, ensure_ascii=False)
    }

def create_error_response(status_code: int, message: str) -> Dict:
    return {
        "statusCode": status_code,
        "body": json.dumps({"message": message}, ensure_ascii=False)
    }
```


### ğŸ“ ãƒ­ã‚°è¨­è¨ˆ

#### **åŸºæœ¬æ–¹é‡**
- CloudWatchã®è‡ªå‹•request_idæ©Ÿèƒ½ã‚’æ´»ç”¨
- æ–‡å­—åˆ—ãƒ™ãƒ¼ã‚¹ãƒ­ã‚°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãƒ»åŠ¹ç‡çš„ï¼‰
- request_idã¯ä¸€åˆ‡æ‰±ã‚ãšã€CloudWatchã«å®Œå…¨ã«ä»»ã›ã‚‹

#### **ãƒ­ã‚°ãƒ‘ã‚¿ãƒ¼ãƒ³**
```python
# åŸºæœ¬ãƒ­ã‚°ï¼ˆCloudWatchè‡ªå‹•request_idä»˜ä¸ï¼‰
logger.info("REQUEST_START")
logger.info(f"REQUEST_VALIDATED - Mode:{mode}")

# å¤–éƒ¨APIè¿½è·¡
logger.info(f"GRAPH_API_CALL - {method} {endpoint}")
logger.error(f"API_ERROR - Status:{status_code} Message:{message}")
```

#### **å¿…é ˆãƒ­ã‚°ãƒã‚¤ãƒ³ãƒˆ**
- å¤–éƒ¨APIå‘¼ã³å‡ºã—
- ãƒªã‚½ãƒ¼ã‚¹ç™ºè¦‹/æœªç™ºè¦‹
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®è©³ç´°æƒ…å ±

### ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»åˆ¶é™

```python
# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
http = urllib3.PoolManager(timeout=urllib3.Timeout(30))

# ç’°å¢ƒå¤‰æ•°å–å¾—
TENANT_ID = os.environ['TENANT_ID']
CLIENT_SECRET = os.environ['CLIENT_SECRET']

# æ©Ÿå¯†æƒ…å ±ãƒ­ã‚°ç¦æ­¢
logger.info("Token retrieved successfully")  # âœ…
# logger.info(f"Token: {access_token}")      # âŒ

# JSONå‡ºåŠ›æ™‚ã®æ—¥æœ¬èªå¯¾å¿œ
json.dumps(data, ensure_ascii=False)  # æ—¥æœ¬èªæ–‡å­—ã‚’æ­£ã—ãè¡¨ç¤º
```

---

## ğŸ”§ å®Ÿè£…ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

### Lambda Handler
```python
def lambda_handler(event: dict, context) -> dict:
    try:
        logger.info("REQUEST_START")
        
        # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»å‡¦ç†
        request_data = validate_and_parse_request(body)
        result = route_by_mode(request_data)
        
        logger.info("REQUEST_SUCCESS")
        return create_success_response("å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ")
        
    except APIException as e:
        logger.error(f"API_ERROR - Status:{e.status_code} Message:{e.message}")
        return create_error_response(e.status_code, e.message)
    except Exception as e:
        logger.error(f"SYSTEM_ERROR - {str(e)}")
        return create_error_response(500, "Internal server error")
```

### å¤–éƒ¨APIå‘¼ã³å‡ºã—
```python
def make_external_request(method: str, url: str, headers: dict,
                         body: Optional[dict] = None) -> dict:
    logger.info(f"EXTERNAL_API_CALL - {method} {url.split('/')[-1]}")
    
    try:
        if body:
            response = http.request(method, url, headers=headers, 
                                   body=json.dumps(body).encode("utf-8"))
        else:
            response = http.request(method, url, headers=headers)
        
        # å¤–éƒ¨APIãƒ¬ã‚¹ãƒãƒ³ã‚¹è§£æ
        try:
            response_data = json.loads(response.data.decode()) if response.data else {}
            external_message = response_data.get('error', {}).get('message', 'Unknown error')
        except:
            external_message = 'Unable to parse response'
        
        if response.status == 401:
            raise ExternalAPIException(401, "Unauthorized access", 
                                     response.status, external_message)
        elif response.status == 404:
            raise ExternalAPIException(404, "Resource not found", 
                                     response.status, external_message)
        elif response.status not in [200, 201]:
            raise ExternalAPIException(502, "External API error", 
                                     response.status, external_message)
        
        logger.info(f"EXTERNAL_API_SUCCESS - Status:{response.status}")
        return json.loads(response.data.decode())
        
    except ExternalAPIException:
        raise
    except Exception as e:
        logger.error(f"EXTERNAL_API_EXCEPTION - Error:{str(e)}")
        raise APIException(502, f"External API request failed: {str(e)}")
```

### Importé †åº
```python
# æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
import json, logging, os
from typing import Any, Dict, List, Optional

# ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ©ã‚¤ãƒ–ãƒ©ãƒª  
import boto3, urllib3
from pydantic import BaseModel, Field, ValidationError, EmailStr

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
from exceptions import APIException
```

---

## âœ… å“è³ªãƒã‚§ãƒƒã‚¯

### å¿…é ˆç¢ºèªé …ç›®
- [ ] é–¢æ•°ã®å˜ä¸€è²¬ä»»ãƒ»50è¡Œä»¥å†…
- [ ] é©åˆ‡ãªHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰  
- [ ] å‹ãƒ’ãƒ³ãƒˆãƒ»Docstringå®Œå‚™
- [ ] æ©Ÿå¯†æƒ…å ±ã®ãƒ­ã‚°å‡ºåŠ›ãªã—
- [ ] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒ»ã‚µã‚¤ã‚ºåˆ¶é™å®Ÿè£…
- [ ] CloudWatchãƒ­ã‚°æœ€é©åŒ–

---

## ğŸ¯ é‡è¦åŸå‰‡

1. **å®Ÿç”¨æ€§å„ªå…ˆ**: ç†æƒ³è«–ã‚ˆã‚Šç¾å®Ÿçš„ãªå®Ÿè£…
2. **CloudWatchæ´»ç”¨**: AWSæ¨™æº–æ©Ÿèƒ½ã‚’æœ€å¤§æ´»ç”¨  
3. **ã‚·ãƒ³ãƒ—ãƒ«è¨­è¨ˆ**: éåº¦ãªæŠ½è±¡åŒ–ã‚’é¿ã‘ã‚‹
4. **é‹ç”¨åŠ¹ç‡**: ä¿å®ˆãƒ»ãƒ‡ãƒãƒƒã‚°ã—ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰


